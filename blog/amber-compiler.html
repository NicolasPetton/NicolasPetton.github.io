<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Amber's new compiler</title>
<!-- 2013-12-03 Tue 15:18 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Nicolas Petton" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href='http://fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic' rel='stylesheet' type='text/css'>
<link rel='stylesheet' href='../css/site.css' type='text/css'/>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css'>
<link rel="alternate" type="application/rss+xml"
                href="http://nicolas-petton.fr/blog/index.xml"
                title="RSS feed">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<div class='nav'>
<ul>
<li><a href='/'>Home</a></li>
<li><a href='/blog/index.html'>Blog</a></li>
<li><a href='http://github.com/NicolasPetton'>GitHub</a></li>
<li><a href='http://twitter.com/NicolasPetton'>Twitter</a></li>
<li><a href='/contact.html'>Contact</a></li>
</ul>
</div>
</div>
<div id="content">
<h1 class="title">Amber's new compiler</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a id="ID-57d2c75a-220f-43cd-97d1-ecd47f9010f8" name="ID-57d2c75a-220f-43cd-97d1-ecd47f9010f8"></a>Amber's new compiler</h2>
<div class="outline-text-2" id="text-1">

<div class="pubdate">
<p>
October 18, 2013
</p>
</div>

<p>
Amber's compiler has been improved some months ago and a post
explaining its new architecture was a long overdue.
</p>

<p>
Following Opal (the new <a href="http://pharo-project.org">Pharo</a> compiler) architecture, the compiler
has been entirely rewritten from a single, complex and stateful AST
visitor into several smaller, single-purpose classes, making it a
more flexible and extensible compiler.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><a id="ID-b922a3e9-fa23-4db9-a86b-8df6bf730977" name="ID-b922a3e9-fa23-4db9-a86b-8df6bf730977"></a>The new architecture</h3>
<div class="outline-text-3" id="text-1-1">

<p>
The AST produced by the parser is first annotated and validated by
the <code>SemanticAnalyzer</code>. The annotation step is important as it adds
semantic knowledge to the AST (scope, variable semantics, etc.).
This way we first make sure that the produced AST is both valid
syntactically and semantically, and keep semantic information
directly in nodes.
</p>


<div class="org-src-container">

<pre class="src src-ruby">| ast ir output |

ast := <span style="color: #b58900;">Smalltalk</span> current <span style="color: #268bd2; font-weight: bold;">parse</span>: <span style="color: #2aa198;">'foo true ifTrue: [ ^ self asString ]'</span>.
(<span style="color: #b58900;">SemanticAnalyzer</span> <span style="color: #268bd2; font-weight: bold;">on</span>: <span style="color: #b58900;">Object</span>) visit: ast.
</pre>
</div>


<p>
The second step is to produce an intermediate representation (IR)
through an <code>IRASTTranslator</code>. The IR tree is similar to the AST but is
simpler and flatten. It doesn't includes cascades for instance, and
cut down most of the tree into a flat list of instructions.
</p>


<div class="org-src-container">

<pre class="src src-ruby">ir := <span style="color: #b58900;">IRASTTranslator</span> new <span style="color: #268bd2; font-weight: bold;">visit</span>: ast.
</pre>
</div>


<p>
From the IR it's a lot easier to perform efficient inlinings. This
optional step is performed by the <code>IRInliner</code> visitor. The <code>IRInlner</code>
replaces parts of the tree, with the inlined equivalent. You can find
the currently inlined send nodes with <code>IRSendInliner class &gt;&gt;
   inlinedSelectors</code>.
</p>

<p>
The final step is then to produce the JavaScript output. This is the
role of the <code>IRJSTranslator</code>. The compiler can then install the method
in the appropriate class.
</p>


<div class="org-src-container">

<pre class="src src-ruby">output := <span style="color: #b58900;">IRJSTranslator</span> new
     <span style="color: #268bd2; font-weight: bold;">currentClass</span>: <span style="color: #b58900;">Object</span>;
     <span style="color: #268bd2; font-weight: bold;">visit</span>: ir;
     contents
</pre>
</div>



<p>
The following diagram shows the current architecture.
</p>

<div class="figure">
<p><img src="../images/amber-compiler.png" alt="amber-compiler.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><a id="ID-b9289317-95e2-422d-b90c-7b0fcd7d7890" name="ID-b9289317-95e2-422d-b90c-7b0fcd7d7890"></a>The public API</h3>
<div class="outline-text-3" id="text-1-2">

<p>
The <code>Compiler</code> facade hides all the internals away and provides the
public API to compile and install methods in Amber. It internally
delegates compiling to an instance of <code>CodeGenerator</code>, or its
subclass <code>InliningCodeGenerator</code> (the default), that will perform
the optional inlining step.
</p>

<div class="org-src-container">

<pre class="src src-ruby"><span style="color: #2aa198;">"Compiling without installing"</span>
<span style="color: #b58900;">Compiler</span> new
     <span style="color: #268bd2; font-weight: bold;">codeGeneratorClass</span>: <span style="color: #b58900;">InliningCodeGenerator</span>; <span style="color: #2aa198;">"Default, can be omitted"</span>
     <span style="color: #268bd2; font-weight: bold;">compile</span>: <span style="color: #2aa198;">'foo true ifTrue: [ ^ self asString ]'</span>
     <span style="color: #268bd2; font-weight: bold;">forClass</span>: <span style="color: #b58900;">Object</span>.

<span style="color: #2aa198;">"Compiling and installing"</span>
<span style="color: #b58900;">Compiler</span> new
     <span style="color: #268bd2; font-weight: bold;">codeGeneratorClass</span>: <span style="color: #b58900;">InliningCodeGenerator</span>; <span style="color: #2aa198;">"Default, can be omitted"</span>
     <span style="color: #268bd2; font-weight: bold;">install</span>: <span style="color: #2aa198;">'foo true ifTrue: [ ^ self asString ]'</span>
     <span style="color: #268bd2; font-weight: bold;">forClass</span>: <span style="color: #b58900;">Object</span>
     <span style="color: #268bd2; font-weight: bold;">category</span>: <span style="color: #2aa198;">'foo'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><a id="ID-f0d4cc95-d0ba-451b-984f-953b67c4c72d" name="ID-f0d4cc95-d0ba-451b-984f-953b67c4c72d"></a>The end</h3>
<div class="outline-text-3" id="text-1-3">

<p>
That's all for now. The new compiler is a very important brick for
Amber. There is still room for improvement, as the generated code
could sometimes be simpler, but it is overall a great improvement
over the old compiler. Together with the new <code>ASTInterpreter</code>, it
will allow fancy new features in Amber, like the new stepping
debugger.
</p>

<p>
I plan to write another post with more details about the inlining
steps. Stay tuned!
</p>



<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'nicolas-petton'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div class='footer'>
Copyright 2013 Nicolas Petton (<a href="http://validator.w3.org/check?uri=referer">Validate</a> HTML).<br>
Last updated 2013-12-03 Tue 15:13. <br>
Built with <a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.1).
</div>
</div>
</body>
</html>
